#include <WiFi.h>
#include <MQTT.h>

// --- กำหนดขาอุปกรณ์ ---
#define LDR_PIN 34
#define RAIN_PIN 35
const int MOTOR_IN1 = 32;
const int MOTOR_IN2 = 33;
const int MOTOR_PWM = 26;

// --- 1. ตั้งค่า Hysteresis (Gap) ---
// Rain: ค่ามาก = เปียก (ตาม Code เดิมของคุณ)
const int RAIN_THRESHOLD_START = 300;  // ฝนตก: ถ้าค่าเกิน 300 -> เก็บผ้าทันที
const int RAIN_THRESHOLD_STOP  = 200;  // ฝนหยุด: ค่าต้องลดลงต่ำกว่า 200 -> ถึงจะยอมให้ตากใหม่

// Light: ค่ามาก = สว่าง
const int LIGHT_THRESHOLD_BRIGHT = 500; // สว่าง: ต้องเกิน 500 -> ถึงจะตาก
const int LIGHT_THRESHOLD_DARK   = 300; // มืด: ถ้าต่ำกว่า 300 -> เก็บ

// --- ตั้งค่า WiFi และ MQTT ---
const char ssid[] = "P11";
const char pass[] = "3333333..";
const char mqtt_broker[] = "test.mosquitto.org";
const char mqtt_topic_sub[] = "home/command";
const char mqtt_topic_pub[] = "home/status";
const char mqtt_client_id[] = "esp32_clothesline_hysteresis";
int MQTT_PORT = 1883;

WiFiClient net;
MQTTClient client;

// --- ตัวแปรระบบ ---
unsigned long lastMillis = 0;
unsigned long motorStartTime = 0;
bool isAutoMode = true;
bool isMotorRunning = false;
String currentStatus = "IDLE";
int clothesState = 0; // 0=Unknown, 1=In, 2=Out
int pwm_speed = 0;

// --- ตัวแปรจำสถานะสภาพอากาศ (Memory for Hysteresis) ---
bool isRainingState = false; // true = ฝนตกอยู่, false = ฝนไม่ตก
bool isDarkState = false;    // true = มืด, false = สว่าง


void connect() {
  Serial.print("Checking WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(1000);
  }
  Serial.print("\nConnecting to MQTT...");
  while (!client.connect(mqtt_client_id)) {
    Serial.print(".");
    delay(1000);
  }
  Serial.println("\nConnected!");
  client.subscribe(mqtt_topic_sub);
}

void stopMotor() {
  digitalWrite(MOTOR_IN1, LOW);
  digitalWrite(MOTOR_IN2, LOW);
  analogWrite(MOTOR_PWM, 0);
  isMotorRunning = false;
  Serial.println("Motor STOPPED.");
}

void startCollect() {
  if (clothesState == 1 && isAutoMode) return;
  Serial.println("Command: COLLECTING...");
  currentStatus = "COLLECTING (กำลังเก็บ)";
  digitalWrite(MOTOR_IN1, LOW);
  digitalWrite(MOTOR_IN2, HIGH);
  analogWrite(MOTOR_PWM, pwm_speed);
  isMotorRunning = true;
  motorStartTime = millis();
  clothesState = 1;
}

void startExtend() {
  if (clothesState == 2 && isAutoMode) return;
  Serial.println("Command: EXTENDING...");
  currentStatus = "EXTENDING (กำลังตาก)";
  digitalWrite(MOTOR_IN1, HIGH);
  digitalWrite(MOTOR_IN2, LOW);
  analogWrite(MOTOR_PWM, pwm_speed);
  isMotorRunning = true;
  motorStartTime = millis();
  clothesState = 2;
}

void messageReceived(String &topic, String &payload) {
  Serial.println("Incoming: " + topic + " - " + payload);
  payload.toLowerCase();
  if (payload == "auto") {
    isAutoMode = true;
    Serial.println("Mode: AUTO");
  } else if (payload == "keep") {
    isAutoMode = false;
    startCollect();
    Serial.println("Mode: MANUAL -> Keep");
  } else if (payload == "out") {
    isAutoMode = false;
    startExtend();
    Serial.println("Mode: MANUAL -> Out");
  }
}

void setup() {
  Serial.begin(9600);
  pinMode(LDR_PIN, INPUT);
  pinMode(RAIN_PIN, INPUT);
  pinMode(MOTOR_IN1, OUTPUT);
  pinMode(MOTOR_IN2, OUTPUT);
  pinMode(MOTOR_PWM, OUTPUT);

  int x = 10;
  pwm_speed = map(x, 0, 10, 0, 255);

  WiFi.begin(ssid, pass);
  client.begin(mqtt_broker, MQTT_PORT, net);
  client.onMessage(messageReceived);
  connect();
}

void loop() {
  client.loop();
  delay(10);
  if (!client.connected()) connect();

  // 1. จัดการ Motor Timing
  if (isMotorRunning) {
    if (millis() - motorStartTime > 600) {

      stopMotor();
      if (clothesState == 1) currentStatus = "KEPT (เก็บอยู่)";
      else if (clothesState == 2) currentStatus = "OUT (ตากอยู่)";
    }
  }

  // อ่านค่าเซนเซอร์
  int rainVal = analogRead(RAIN_PIN);
  int lightVal = analogRead(LDR_PIN);

  // ==========================================================
  // 2. Logic โหมด Auto + Hysteresis (ส่วนที่แก้ไข)
  // ==========================================================
  
  // 2.1 อัปเดตสถานะ "ฝน" ด้วย Hysteresis
  if (rainVal > RAIN_THRESHOLD_START) {
    isRainingState = true;  // ฝนตกแน่นอน
  } else if (rainVal < RAIN_THRESHOLD_STOP) {
    isRainingState = false; // แห้งสนิทแล้วจริงๆ
  }
  // หมายเหตุ: ถ้าค่าอยู่ระหว่าง STOP(200) กับ START(300) ให้ใช้ค่าเดิม (ไม่เปลี่ยน)

  // 2.2 อัปเดตสถานะ "แสง" ด้วย Hysteresis
  if (lightVal < LIGHT_THRESHOLD_DARK) {
    isDarkState = true;     // มืดแล้ว
  } else if (lightVal > LIGHT_THRESHOLD_BRIGHT) {
    isDarkState = false;    // สว่างชัดเจน
  }
  // หมายเหตุ: ถ้าค่าอยู่ระหว่าง DARK(300) กับ BRIGHT(500) ให้ใช้ค่าเดิม

  // 2.3 ตัดสินใจสั่งมอเตอร์ (Decision Logic)
  if (isAutoMode && !isMotorRunning) {
    
    // Priority 1: ฝนตก -> เก็บ
    if (isRainingState) {
      startCollect();
    }
    // Priority 2: ฝนไม่ตก แต่ มืด -> เก็บ
    else if (isDarkState) {
      startCollect();
    }
    // Priority 3: ฝนไม่ตก และ สว่าง -> ตาก
    else {
      startExtend();
    }

  }

  // 1. กราฟฝน (Rain)
  Serial.print("RainVal:");    Serial.print(rainVal);              // ค่าสดจากเซนเซอร์
  Serial.print(",RainON:");    Serial.print(RAIN_THRESHOLD_START); // เส้น 300
  Serial.print(",RainOFF:");   Serial.print(RAIN_THRESHOLD_STOP);  // เส้น 200

  // 2. กราฟแสง (Light) 
  Serial.print(",LightVal:");  Serial.print(lightVal);             // ค่าสดจากเซนเซอร์
  Serial.print(",LightON:");   Serial.print(LIGHT_THRESHOLD_BRIGHT);// เส้น 500
  Serial.print(",LightOFF:");  Serial.print(LIGHT_THRESHOLD_DARK);  // เส้น 300

  
  Serial.println();


  // 3. ส่ง MQTT
  if (millis() - lastMillis > 200) {
    lastMillis = millis();
    String modeStr = isAutoMode ? "AUTO" : "MANUAL";
    String rainStatus = isRainingState ? "WET" : "DRY"; // แสดงสถานะที่ผ่าน Hysteresis แล้ว
    
    String msg = "Mode:" + modeStr +
                 " | Light:" + String(lightVal) +
                 " | Rain:" + String(rainVal) + " (" + rainStatus + ")" +
                 " | " + currentStatus;

    client.publish(mqtt_topic_pub, msg);
    Serial.println(msg);
  }

}

